# Голосовой чат (аналог Discord)

## 1. Тема и целевая аудитория

### Ключевой функционал
- Регистрация/Авторизация
- Профиль
- Личные голосовые чаты
- Групповые голосовые чаты 
- "Сервера" с несколькими голосовыми каналами

### Целевая аудитория
150 млн пользователей в месяц по всему миру  
- Северная Америка - 30%  
- Европа - 15%  
- Южная Америка - 12%

Остальное распределено по миру.

## 2. Расчет нагрузки

### Продуктовые метрики

| Метрика                                      | Значение |
| -------------------------------------------- | -------- |
| Зарегистрированных пользователей             | 500 млн  |
| Месячная аудитория                           | 150 млн  |
| Суточная аудитория                           | 20 млн   |
| Максимальное количество пользователей онлайн | 10 млн   |
| Минут голосового общения в день              | 4 млрд   |
| Средний размер хранилища пользователя        | 1 Мб     |

Хранилище требуется только для пользовательских данных (никнейм, почта, хэш пароля) и аватара.  
Пользовательские данные пренебрежимо малы по сравнению с аватаром, аватар в среднем занимает 1 Мб

### Количество операций по типам

| Операция                         | Среднее кол-во в день на пользователя |
| -------------------------------- | :-----------------------------------: |
| Авторизация                      |                   2                   |
| Смена аватара                    |                  0.2                  |
| Вход в голосовой чат/канал       |                  10                   |
| Получение списка участников чата |                  20                   |
| Получение списка чатов           |                  10                   |

### Технические метрики

#### Хранилище

Учитывая средний размер хранилища пользователя 1 Мб и кол-во зарегистрированных пользователей 500 млн, потребуется:  
`500 млн * 1 Мб = 500 Тб`

#### RPS

Предлагаю для удобства объединить "Вход в голосовой чат", "Получение списка участников чата", "Получение списка чатов"
в один тип запросов, назовём его "Основной пользовательский сценарий"

| Операция                           | Число запросов | Максимально допустимое время операции, с |
| ---------------------------------- | :------------: | :--------------------------------------: |
| Авторизация                        |       1        |                    5                     |
| Смена аватара                      |       1        |                    7                     |
| Основной пользовательский сценарий |       3        |                    3                     |

Учитывая 20 млн DAU и 10 млн пиковый онлайн:  
Считаем средний RPS по формуле: `20 млн * N / 24 / 3600`, где N - число операций определённого типа  
Считаем пиковый RPS по формуле: `10 млн * N / T`, где N - число запросов в операции, T - максимально допустимое время операции

| Операция                           | Средний RPS | Пиковый RPS |
| ---------------------------------- | :---------: | :---------: |
| Авторизация                        |     463     |    2 млн    |
| Смена аватара                      |     46      |   1.4 млн   |
| Основной пользовательский сценарий |    9259     |   10 млн    |

#### Сетевой трафик

Пусть битрейт звука в голосовых чатах - 96 кбит/с  

Учитывая 4 млрд минут голосового общения в день, суммарный суточный трафик для голосовых чатов:  
`4 млрд * 60 с * 96 кбит/с = 23 040 000 Гбит/сутки = 23 040 000 * 0.116 = 2 672 640 Гбайт/сутки`

Учитывая 10 млн максимально пользователей онлайн, пиковое потребление трафика:  
`10 млн * 96 кбит/с = 960 Гбит/c`

##  Источники
1. https://discord.com/company
2. https://www.bankmycell.com/blog/number-of-discord-users
3. https://worldpopulationreview.com/country-rankings/discord-users-by-country
4. https://support.discord.com/hc/en-us/articles/11635925354775-Audio-Bitrate-FAQ
5. https://priocept.com/2009/08/21/calculating-http-server-load/
